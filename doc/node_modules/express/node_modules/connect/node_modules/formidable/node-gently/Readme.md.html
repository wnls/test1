<!DOCTYPE html>
<html>
<head>
  <title>Readme.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../../doc-style.css" />
  <script src="../../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../../", thisFile = "node_modules/express/node_modules/connect/node_modules/formidable/node-gently/Readme.md", defaultSidebar = true;
  </script>
  <script src="../../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#gently">Gently</a>
      </div>
      <div class="heading h2">
        <a href="#purpose">Purpose</a>
      </div>
      <div class="heading h2">
        <a href="#features">Features</a>
      </div>
      <div class="heading h2">
        <a href="#installation">Installation</a>
      </div>
      <div class="heading h2">
        <a href="#example">Example</a>
      </div>
      <div class="heading h2">
        <a href="#api">API</a>
      </div>
      <div class="heading h3">
        <a href="#gently">Gently</a>
      </div>
      <div class="heading h4">
        <a href="#new-gently--">new Gently()</a>
      </div>
      <div class="heading h4">
        <a href="#gently.expect-obj--method----count---stubfn--">gently.expect(obj, method, [[count], stubFn])</a>
      </div>
      <div class="heading h4">
        <a href="#gently.expect--count---stubfn-">gently.expect([count], stubFn)</a>
      </div>
      <div class="heading h4">
        <a href="#gently.restore-obj--method-">gently.restore(obj, method)</a>
      </div>
      <div class="heading h4">
        <a href="#gently.hijack-realrequire-">gently.hijack(realRequire)</a>
      </div>
      <div class="heading h4">
        <a href="#gently.stub-location---exportsname--">gently.stub(location, [exportsName])</a>
      </div>
      <div class="heading h4">
        <a href="#gently.hijacked">gently.hijacked</a>
      </div>
      <div class="heading h4">
        <a href="#gently.verify--msg--">gently.verify([msg])</a>
      </div>
      <div class="heading h2">
        <a href="#license">License</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="docs markdown">
<div class="pilwrap" id="gently">
  <h1>
    <a href="#gently" class="pilcrow">&#182;</a>
    Gently
  </h1>
</div>



<div class="pilwrap" id="purpose">
  <h2>
    <a href="#purpose" class="pilcrow">&#182;</a>
    Purpose
  </h2>
</div>


<p>A node.js module that helps with stubbing and behavior verification. It allows you to test the most remote and nested corners of your code while keeping being fully unobtrusive.</p>


<div class="pilwrap" id="features">
  <h2>
    <a href="#features" class="pilcrow">&#182;</a>
    Features
  </h2>
</div>


<ul>
<li>Overwrite and stub individual object functions</li>
<li>Verify that all expected calls have been made in the expected order</li>
<li>Restore stubbed functions to their original behavior</li>
<li>Detect object / class names from obj.constructor.name and obj.toString()</li>
<li>Hijack any required module function or class constructor</li>
</ul>


<div class="pilwrap" id="installation">
  <h2>
    <a href="#installation" class="pilcrow">&#182;</a>
    Installation
  </h2>
</div>


<p>Via <a href="http://github.com/isaacs/npm">npm</a>:</p>


<div class="highlight"><pre><code><span class="n">npm</span> <span class="n">install</span> <span class="n">gently</span><span class="err">@</span><span class="n">latest</span>
</code></pre></div>




<div class="pilwrap" id="example">
  <h2>
    <a href="#example" class="pilcrow">&#182;</a>
    Example
  </h2>
</div>


<p>Make sure your dog is working properly:</p>


<div class="highlight"><pre><code><span class="kd">function</span> <span class="nx">Dog</span><span class="p">()</span> <span class="p">{}</span>

<span class="nx">Dog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">seeCat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">bark</span><span class="p">(</span><span class="s1">&#39;whuf, whuf&#39;</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">Dog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bark</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bark</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">).</span><span class="nx">puts</span><span class="p">(</span><span class="nx">bark</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">gently</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gently&#39;</span><span class="p">))</span>
  <span class="p">,</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">dog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dog</span><span class="p">();</span>

<span class="nx">gently</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="nx">dog</span><span class="p">,</span> <span class="s1">&#39;bark&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bark</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">bark</span><span class="p">,</span> <span class="s1">&#39;whuf, whuf&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">gently</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="nx">dog</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">);</span>

<span class="nx">dog</span><span class="p">.</span><span class="nx">seeCat</span><span class="p">();</span>
</code></pre></div>



<p>You can also easily test event emitters with this, for example a simple sequence of 2 events emitted by <code>fs.WriteStream</code>:</p>


<div class="highlight"><pre><code><span class="kd">var</span> <span class="nx">gently</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gently&#39;</span><span class="p">))</span>
  <span class="p">,</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">).</span><span class="nx">WriteStream</span><span class="p">)(</span><span class="s1">&#39;my_file.txt&#39;</span><span class="p">);</span>

<span class="nx">gently</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="s1">&#39;emit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">gently</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="s1">&#39;emit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="s1">&#39;drain&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>



<p>For a full read world example, check out this test case: <a href="http://github.com/felixge/node-formidable/blob/master/test/simple/test-incoming-form.js">test-incoming-form.js</a> (in <a href="http://github.com/felixge/node-formidable">node-formdiable</a>).</p>


<div class="pilwrap" id="api">
  <h2>
    <a href="#api" class="pilcrow">&#182;</a>
    API
  </h2>
</div>



<div class="pilwrap" id="gently">
  <h3>
    <a href="#gently" class="pilcrow">&#182;</a>
    Gently
  </h3>
</div>



<div class="pilwrap" id="new-gently--">
  <h4>
    <a href="#new-gently--" class="pilcrow">&#182;</a>
    new Gently()
  </h4>
</div>


<p>Creates a new gently instance. It listens to the process <code>'exit'</code> event to make sure all expectations have been verified.</p>


<div class="pilwrap" id="gently.expect-obj--method----count---stubfn--">
  <h4>
    <a href="#gently.expect-obj--method----count---stubfn--" class="pilcrow">&#182;</a>
    gently.expect(obj, method, [[count], stubFn])
  </h4>
</div>


<p>Creates an expectation for an objects method to be called. You can optionally specify the call <code>count</code> you are expecting, as well as <code>stubFn</code> function that will run instead of the original function.</p>

<p>Returns a reference to the function that is getting overwritten.</p>


<div class="pilwrap" id="gently.expect--count---stubfn-">
  <h4>
    <a href="#gently.expect--count---stubfn-" class="pilcrow">&#182;</a>
    gently.expect([count], stubFn)
  </h4>
</div>


<p>Returns a function that is supposed to be executed <code>count</code> times, delegating any calls to the provided <code>stubFn</code> function. Naming your stubFn closure will help to properly diagnose errors that are being thrown:</p>


<div class="highlight"><pre><code><span class="nx">childProcess</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="nx">gently</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="kd">function</span> <span class="nx">lsCallback</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">code</span><span class="p">);</span>
<span class="p">}));</span>
</code></pre></div>




<div class="pilwrap" id="gently.restore-obj--method-">
  <h4>
    <a href="#gently.restore-obj--method-" class="pilcrow">&#182;</a>
    gently.restore(obj, method)
  </h4>
</div>


<p>Restores an object method that has been previously overwritten using <code>gently.expect()</code>.</p>


<div class="pilwrap" id="gently.hijack-realrequire-">
  <h4>
    <a href="#gently.hijack-realrequire-" class="pilcrow">&#182;</a>
    gently.hijack(realRequire)
  </h4>
</div>


<p>Returns a new require functions that catches a reference to all required modules into <code>gently.hijacked</code>.</p>

<p>To use this function, include a line like this in your <code>'my-module.js'</code>.</p>


<div class="highlight"><pre><code><span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">GENTLY</span><span class="p">)</span> <span class="nx">require</span> <span class="o">=</span> <span class="nx">GENTLY</span><span class="p">.</span><span class="nx">hijack</span><span class="p">(</span><span class="nx">require</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">);</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">hello</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>



<p>Now you can write a test for the module above:</p>


<div class="highlight"><pre><code><span class="kd">var</span> <span class="nx">gently</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">GENTLY</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gently&#39;</span><span class="p">))</span>
  <span class="p">,</span> <span class="nx">myModule</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./my-module&#39;</span><span class="p">);</span>

<span class="nx">gently</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="nx">gently</span><span class="p">.</span><span class="nx">hijacked</span><span class="p">.</span><span class="nx">sys</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">myModule</span><span class="p">.</span><span class="nx">hello</span><span class="p">();</span>
</code></pre></div>




<div class="pilwrap" id="gently.stub-location---exportsname--">
  <h4>
    <a href="#gently.stub-location---exportsname--" class="pilcrow">&#182;</a>
    gently.stub(location, [exportsName])
  </h4>
</div>


<p>Returns a stub class that will be used instead of the real class from the module at <code>location</code> with the given <code>exportsName</code>.</p>

<p>This allows to test an OOP version of the previous example, where <code>'my-module.js'</code>.</p>


<div class="highlight"><pre><code><span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">GENTLY</span><span class="p">)</span> <span class="nx">require</span> <span class="o">=</span> <span class="nx">GENTLY</span><span class="p">.</span><span class="nx">hijack</span><span class="p">(</span><span class="nx">require</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">World</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./world&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">hello</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">world</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">World</span><span class="p">();</span>
  <span class="nx">world</span><span class="p">.</span><span class="nx">hello</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>



<p>And <code>world.js</code> looks like this:</p>


<div class="highlight"><pre><code><span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">World</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">World</span><span class="p">;</span>

<span class="nx">World</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hello</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>



<p>Testing <code>'my-module.js'</code> can now easily be accomplished:</p>


<div class="highlight"><pre><code><span class="kd">var</span> <span class="nx">gently</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">GENTLY</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gently&#39;</span><span class="p">))</span>
  <span class="p">,</span> <span class="nx">WorldStub</span> <span class="o">=</span> <span class="nx">gently</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="s1">&#39;./world&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">myModule</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./my-module&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">WORLD</span><span class="p">;</span>

<span class="nx">gently</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="nx">WorldStub</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">WORLD</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">gently</span><span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="nx">WORLD</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">);</span>

<span class="nx">myModule</span><span class="p">.</span><span class="nx">hello</span><span class="p">();</span>
</code></pre></div>




<div class="pilwrap" id="gently.hijacked">
  <h4>
    <a href="#gently.hijacked" class="pilcrow">&#182;</a>
    gently.hijacked
  </h4>
</div>


<p>An object that holds the references to all hijacked modules.</p>


<div class="pilwrap" id="gently.verify--msg--">
  <h4>
    <a href="#gently.verify--msg--" class="pilcrow">&#182;</a>
    gently.verify([msg])
  </h4>
</div>


<p>Verifies that all expectations of this gently instance have been satisfied. If not called manually, this method is called when the process <code>'exit'</code> event is fired.</p>

<p>If <code>msg</code> is given, it will appear in any error that might be thrown.</p>


<div class="pilwrap" id="license">
  <h2>
    <a href="#license" class="pilcrow">&#182;</a>
    License
  </h2>
</div>


<p>Gently is licensed under the MIT license.</p></div>
  </div>
</body>
</html>
