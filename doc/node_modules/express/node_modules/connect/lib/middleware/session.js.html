<!DOCTYPE html>
<html>
<head>
  <title>session.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../doc-style.css" />
  <script src="../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../../../../", thisFile = "node_modules/express/node_modules/connect/lib/middleware/session.js", defaultSidebar = true;
  </script>
  <script src="../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h2">
        <a href="#req.session">req.session</a>
      </div>
      <div class="heading h2">
        <a href="#session-regenerate--">Session#regenerate()</a>
      </div>
      <div class="heading h2">
        <a href="#session-destroy--">Session#destroy()</a>
      </div>
      <div class="heading h2">
        <a href="#session-reload--">Session#reload()</a>
      </div>
      <div class="heading h2">
        <a href="#session-save--">Session#save()</a>
      </div>
      <div class="heading h2">
        <a href="#session-touch--">Session#touch()</a>
      </div>
      <div class="heading h2">
        <a href="#session-cookie">Session#cookie</a>
      </div>
      <div class="heading h2">
        <a href="#session-maxage">Session#maxAge</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>session.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>!
Connect - session
Copyright(c) 2010 Sencha Inc.
Copyright(c) 2011 TJ Holowaychuk
MIT Licensed</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Module dependencies.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">Session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./session/session&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;connect:session&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">MemoryStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./session/memory&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cookie-signature&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Cookie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./session/cookie&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Store</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./session/store&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">utils</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./../utils&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">parse</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">parseUrl</span>
  <span class="p">,</span> <span class="nx">crc32</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;buffer-crc32&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>environment</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Expose the middleware.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Expose constructors.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">exports</span><span class="p">.</span><span class="nx">Store</span> <span class="o">=</span> <span class="nx">Store</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">Cookie</span> <span class="o">=</span> <span class="nx">Cookie</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">Session</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">MemoryStore</span> <span class="o">=</span> <span class="nx">MemoryStore</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Warning message for <code>MemoryStore</code> usage in production.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">warning</span> <span class="o">=</span> <span class="s1">&#39;Warning: connection.session() MemoryStore is not\n&#39;</span>
  <span class="o">+</span> <span class="s1">&#39;designed for a production environment, as it will leak\n&#39;</span>
  <span class="o">+</span> <span class="s1">&#39;memory, and will not scale past a single process.&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary"><p>Session:</p>
  </div>
  <div class="body"><p>Setup session store with the given <code>options</code>.</p>

<p>Session data is <em>not</em> saved in the cookie itself, however
  cookies are used, so we must use the <a href="cookieParser.html">cookieParser()</a>
  middleware <em>before</em> <code>session()</code>.</p>

<p>Examples:</p>

<p>connect()
      .use(connect.cookieParser())
      .use(connect.session({ secret: 'keyboard cat', key: 'sid', cookie: { secure: true }}))</p>

<p>Options:</p>

<ul>
<li><code>key</code> cookie name defaulting to <code>connect.sid</code>
<ul><li><code>store</code> session store instance</li>
<li><code>secret</code> session cookie is signed with this secret to prevent tampering</li>
<li><code>cookie</code> session cookie settings, defaulting to <code>{ path: '/', httpOnly: true, maxAge: null }</code></li>
<li><code>proxy</code> trust the reverse proxy when setting secure cookies (via "x-forwarded-proto")</li></ul></li>
</ul>

<p>Cookie option:</p>

<p>By default <code>cookie.maxAge</code> is <code>null</code>, meaning no "expires" parameter is set
 so the cookie becomes a browser-session cookie. When the user closes the 
 browser the cookie (and session) will be removed.</p>


<div class="pilwrap" id="req.session">
  <h2>
    <a href="#req.session" class="pilcrow">&#182;</a>
    req.session
  </h2>
</div>


<p>To store or access session data, simply use the request property <code>req.session</code>,
 which is (generally) serialized as JSON by the store, so nested objects 
 are typically fine. For example below is a user-specific view counter:</p>

<p>connect()
        .use(connect.favicon())
        .use(connect.cookieParser())
        .use(connect.session({ secret: 'keyboard cat', cookie: { maxAge: 60000 }}))
        .use(function(req, res, next){
          var sess = req.session;
          if (sess.views) {
            res.setHeader('Content-Type', 'text/html');
            res.write('<p>views: ' + sess.views + '</p>');
            res.write('<p>expires in: ' + (sess.cookie.maxAge / 1000) + 's</p>');
            res.end();
            sess.views++;
          } else {
            sess.views = 1;
            res.end('welcome to the session demo. refresh!');
          }
        }
      )).listen(3000);</p>


<div class="pilwrap" id="session-regenerate--">
  <h2>
    <a href="#session-regenerate--" class="pilcrow">&#182;</a>
    Session#regenerate()
  </h2>
</div>


<p>To regenerate the session simply invoke the method, once complete
 a new SID and <code>Session</code> instance will be initialized at <code>req.session</code>.</p>

<p>req.session.regenerate(function(err){
       // will have a new session here
     });</p>


<div class="pilwrap" id="session-destroy--">
  <h2>
    <a href="#session-destroy--" class="pilcrow">&#182;</a>
    Session#destroy()
  </h2>
</div>


<p>Destroys the session, removing <code>req.session</code>, will be re-generated next request.</p>

<p>req.session.destroy(function(err){
       // cannot access session here
     });</p>


<div class="pilwrap" id="session-reload--">
  <h2>
    <a href="#session-reload--" class="pilcrow">&#182;</a>
    Session#reload()
  </h2>
</div>


<p>Reloads the session data.</p>

<p>req.session.reload(function(err){
       // session updated
     });</p>


<div class="pilwrap" id="session-save--">
  <h2>
    <a href="#session-save--" class="pilcrow">&#182;</a>
    Session#save()
  </h2>
</div>


<p>Save the session.</p>

<p>req.session.save(function(err){
       // session saved
     });</p>


<div class="pilwrap" id="session-touch--">
  <h2>
    <a href="#session-touch--" class="pilcrow">&#182;</a>
    Session#touch()
  </h2>
</div>


<p>Updates the <code>.maxAge</code> property. Typically this is
  not necessary to call, as the session middleware does this for you.</p>


<div class="pilwrap" id="session-cookie">
  <h2>
    <a href="#session-cookie" class="pilcrow">&#182;</a>
    Session#cookie
  </h2>
</div>


<p>Each session has a unique cookie object accompany it. This allows
 you to alter the session cookie per visitor. For example we can
 set <code>req.session.cookie.expires</code> to <code>false</code> to enable the cookie
 to remain for only the duration of the user-agent.</p>


<div class="pilwrap" id="session-maxage">
  <h2>
    <a href="#session-maxage" class="pilcrow">&#182;</a>
    Session#maxAge
  </h2>
</div>


<p>Alternatively <code>req.session.cookie.maxAge</code> will return the time
 remaining in milliseconds, which we may also re-assign a new value
 to adjust the <code>.expires</code> property appropriately. The following
 are essentially equivalent</p>

<p>var hour = 3600000;
    req.session.cookie.expires = new Date(Date.now() + hour);
    req.session.cookie.maxAge = hour;</p>

<p>For example when <code>maxAge</code> is set to <code>60000</code> (one minute), and 30 seconds
has elapsed it will return <code>30000</code> until the current request has completed,
at which time <code>req.session.touch()</code> is called to reset <code>req.session.maxAge</code>
to its original value.</p>

<p>req.session.cookie.maxAge;
    // => 30000</p>

<p>Session Store Implementation:</p>

<p>Every session store <em>must</em> implement the following methods</p>

<ul>
<li><code>.get(sid, callback)</code>
<ul><li><code>.set(sid, session, callback)</code></li>
<li><code>.destroy(sid, callback)</code></li></ul></li>
</ul>

<p>Recommended methods include, but are not limited to:</p>

<ul>
<li><code>.length(callback)</code>
<ul><li><code>.clear(callback)</code></li></ul></li>
</ul>

<p>For an example implementation view the <a href="http://github.com/visionmedia/connect-redis">connect-redis</a> repo.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">Object</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Function</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">function</span> <span class="nx">session</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{}</span>
    <span class="p">,</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span> <span class="o">||</span> <span class="s1">&#39;connect.sid&#39;</span>
    <span class="p">,</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">store</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">MemoryStore</span>
    <span class="p">,</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">||</span> <span class="p">{}</span>
    <span class="p">,</span> <span class="nx">trustProxy</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">proxy</span>
    <span class="p">,</span> <span class="nx">storeReady</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>notify user that this store is not
meant for a production environment</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;production&#39;</span> <span class="o">==</span> <span class="nx">env</span> <span class="o">&amp;&amp;</span> <span class="nx">store</span> <span class="k">instanceof</span> <span class="nx">MemoryStore</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">warning</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>generates the new session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">store</span><span class="p">.</span><span class="nx">generate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">){</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">uid</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Session</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nx">cookie</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">store</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">storeReady</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">});</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">storeReady</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="p">});</span>

  <span class="k">return</span> <span class="kd">function</span> <span class="nx">session</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>self-awareness</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>Handle connection as if there is no session if
the store has temporarily disconnected etc</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">storeReady</span><span class="p">)</span> <span class="k">return</span> <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;store is disconnected&#39;</span><span class="p">),</span> <span class="nx">next</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>pathname mismatch</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">originalUrl</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>backwards compatibility for signed cookies
req.secret is passed from the cookie parser middleware</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">secret</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">secret</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">secret</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>ensure secret is available or bail</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">secret</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;`secret` option required for sessions&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>parse url</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">originalHash</span>
      <span class="p">,</span> <span class="nx">originalId</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>expose store</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">req</span><span class="p">.</span><span class="nx">sessionStore</span> <span class="o">=</span> <span class="nx">store</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>grab the session cookie value and check the signature</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">rawCookie</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>get signedCookies for backwards compat with signed cookies</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">unsignedCookie</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">signedCookies</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">unsignedCookie</span> <span class="o">&amp;&amp;</span> <span class="nx">rawCookie</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">unsignedCookie</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">parseSignedCookie</span><span class="p">(</span><span class="nx">rawCookie</span><span class="p">,</span> <span class="nx">secret</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>set-cookie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">cookie</span>
        <span class="p">,</span> <span class="nx">proto</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;x-forwarded-proto&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span>
        <span class="p">,</span> <span class="nx">tls</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">encrypted</span> <span class="o">||</span> <span class="p">(</span><span class="nx">trustProxy</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;https&#39;</span> <span class="o">==</span> <span class="nx">proto</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">secured</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">secure</span> <span class="o">&amp;&amp;</span> <span class="nx">tls</span>
        <span class="p">,</span> <span class="nx">isNew</span> <span class="o">=</span> <span class="nx">unsignedCookie</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>only send secure cookies via https</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">secure</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">secured</span><span class="p">)</span> <span class="k">return</span> <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;not secured&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>browser-session length cookie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">expires</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNew</span><span class="p">)</span> <span class="k">return</span> <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;already set browser-session cookie&#39;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>compare hashes and ids</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">originalHash</span> <span class="o">==</span> <span class="nx">hash</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">originalId</span> <span class="o">==</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;unmodified session&#39;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="s1">&#39;s:&#39;</span> <span class="o">+</span> <span class="nx">signature</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span> <span class="nx">secret</span><span class="p">);</span>
      <span class="nx">val</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;set-cookie %s&#39;</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>proxy end() to commit the session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">){</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">end</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">);</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;saving&#39;</span><span class="p">);</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">resetMaxAge</span><span class="p">();</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;saved&#39;</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>generate the session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">generate</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>get the sessionID from the cookie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">req</span><span class="p">.</span><span class="nx">sessionID</span> <span class="o">=</span> <span class="nx">unsignedCookie</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>generate a session if the browser doesn't send a sessionID</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;no SID sent, generating session&#39;</span><span class="p">);</span>
      <span class="nx">generate</span><span class="p">();</span>
      <span class="nx">next</span><span class="p">();</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>generate the session object</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">pause</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">pause</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;fetching %s&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">);</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sess</span><span class="p">){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>proxy to resume() events</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">_next</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span>
      <span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">_next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="nx">pause</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>
      <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>error handling</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ENOENT&#39;</span> <span class="o">==</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">generate</span><span class="p">();</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>no session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sess</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;no session found&#39;</span><span class="p">);</span>
        <span class="nx">generate</span><span class="p">();</span>
        <span class="nx">next</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>populate req.session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;session found&#39;</span><span class="p">);</span>
        <span class="nx">store</span><span class="p">.</span><span class="nx">createSession</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">sess</span><span class="p">);</span>
        <span class="nx">originalId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">;</span>
        <span class="nx">originalHash</span> <span class="o">=</span> <span class="nx">hash</span><span class="p">(</span><span class="nx">sess</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Hash the given <code>sess</code> object omitting changes
to <code>.cookie</code>.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">sess</span>
      <span class="dox_type">Object</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">String</span>
    </div>
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </span>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">function</span> <span class="nx">hash</span><span class="p">(</span><span class="nx">sess</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">crc32</span><span class="p">.</span><span class="nx">signed</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">sess</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;cookie&#39;</span> <span class="o">!=</span> <span class="nx">key</span><span class="p">)</span> <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">}));</span>
<span class="p">}</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
